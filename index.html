<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Article Manager QR Scanner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@9.0.0/dist/pouchdb.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { padding: 20px; }
    #article-info, #article-new { display: none; margin-top: 20px; }
  </style>
</head>
<body class="container">
  <h2 class="mb-4">Article Manager QR Scanner</h2>

  <div id="qr-reader" style="width: 300px"></div>
  <button class="btn btn-primary mt-2" onclick="startScanner()">Scan QR Code</button>

  <div id="article-info" class="mt-4">
    <div class="alert alert-success">Article found! Please make your changes</div>
    <table class="table table-bordered">
      <thead class="table-light">
        <tr><th>Article ID</th><th>Article</th><th>Amount</th><th>Edit</th><th>Delete</th></tr>
      </thead>
      <tbody id="article-table-body"></tbody>
    </table>
  </div>

  <div id="article-new" class="mt-4">
    <div class="alert alert-warning">Article not found! Please enter details for new article</div>
    <div class="mb-3">
      <label class="form-label">Article ID</label>
      <input type="text" id="new-id" class="form-control">
    </div>
    <div class="mb-3">
      <label class="form-label">Article</label>
      <input type="text" id="new-name" class="form-control">
    </div>
    <div class="mb-3">
      <label class="form-label">Amount on stock</label>
      <input type="number" id="new-amount" class="form-control">
    </div>
    <button class="btn btn-success" onclick="saveNewArticle()">Save article</button>
  </div>

  <script>
    const db = new PouchDB('brammen');
    const remoteDb = new PouchDB('admin:passwort@localhost:5984/brammen');

    db.sync(remoteDb, { live: true, retry: true });

    function startScanner() {
      const html5QrCode = new Html5Qrcode("qr-reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 30, qrbox: 400 },
        qrCodeMessage => {
          html5QrCode.stop();
          lookupArticle(qrCodeMessage);
        }
      );
    }

    
    function lookupArticle(id) {
      db.get(id).then(doc => {
        showArticle(doc);
      }).catch(err => {
        if (err.status === 404) {
          showNewArticleForm(id);
        } else {
          console.error(err);
        }
      });
    }

    function showArticle(article) {
      document.getElementById('article-info').style.display = 'block';
      document.getElementById('article-new').style.display = 'none';
      const tbody = document.getElementById('article-table-body');
      tbody.innerHTML = `
        <tr>
          <td>${article._id}</td>
          <td>${article.name}</td>
          <td>${article.amount}</td>
          <td><button class="btn btn-sm btn-warning" onclick="editArticle('${article._id}')">Edit</button></td>
          <td><button class="btn btn-sm btn-danger" onclick="deleteArticle('${article._id}', '${article._rev}')">Delete</button></td>
        </tr>
      `;
    }

    function showNewArticleForm(id) {
      document.getElementById('article-info').style.display = 'none';
      document.getElementById('article-new').style.display = 'block';
      document.getElementById('new-id').value = id;
      document.getElementById('new-name').value = '';
      document.getElementById('new-amount').value = 0;
    }

    function saveNewArticle() {
      const id = document.getElementById('new-id').value;
      const name = document.getElementById('new-name').value;
      const amount = parseInt(document.getElementById('new-amount').value);

      db.put({ _id: id, name, amount }).then(() => {
        alert('Article saved');
        document.getElementById('article-new').style.display = 'none';
      });
    }

    function editArticle(id) {
      const newAmount = prompt("New amount:");
      db.get(id).then(doc => {
        doc.amount = parseInt(newAmount);
        return db.put(doc);
      }).then(() => alert('Article updated'));
    }

    function deleteArticle(id, rev) {
      db.remove(id, rev).then(() => {
        alert('Article deleted');
        document.getElementById('article-info').style.display = 'none';
      });
    }
  </script>
</body>
</html>
